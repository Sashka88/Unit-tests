
import org.testng.Assert;
import org.testng.annotations.DataProvider;
import org.testng.annotations.Optional;
import org.testng.annotations.Parameters;
import org.testng.annotations.Test;

import java.io.ByteArrayOutputStream;
import java.io.PrintStream;
import java.lang.reflect.Field;


public class PenTest {

    @DataProvider
    public Object[][] inkContainerValueData() {
        return new Object[][]{
                {1},
                {0},
                {-1}
        };
    }
    @DataProvider
    public Object[][] inkAndSizeLetterData() {
        return new Object[][]{
                {10, 1.0},
                {1, 10.0}
        };
    }
    @DataProvider
    public Object[][] inkSizeColorPenData() {
        return new Object[][]{
                {10, 1.0, "GREEN"},
                {20, 2.0, "BLUE"},
        };
    }
    @DataProvider
    public Object[][] negativeInkDataAndWord() {
        return new Object[][]{
                {-1, "Hello"},
                {0, "Hello"},
        };
    }
    @DataProvider
    public Object[][] positiveInkSizeAndWord() {
        return new Object[][]{
                {100, 1.0, "Hello"},
        };
    }
    @DataProvider
    public Object[][] checkSymbols() {
        return new Object[][]{
                {100, 1.0, "Привет", "Write method should return word"},
                {100, 1.0, "17383023", "Write method should return numbers" },
                {100, 1.0, "TEST", "Write method should return uppercase word"},
                {100, 1.0, "test", "Write method should return lowercase word"},
                {100, 1.0, "!@#№$;.,%:^&?*()_-|{}[]<>'|/~ ", "Write method should return special characters"},
                {1, 1.0, "\n", "Write method use ink to transfer carriage"},
                {100, 1.0, " Hello ", "Write method should return word with spaces"},
                {100, 1.0, "新的一年", "Write method should return chinese word"},
                {100, 1.0, "( ´ ∀ `)ノ～ ♡ (*ﾉωﾉ)", "Write method should return emoji"},
        };
    }
    @DataProvider
    public Object[][] checkDifferentInkAndSizeValue() {
        return new Object[][]{
                {5, 1.0, "Value", "Write method should return provided text when pen has enough ink"}
        };
    }
    @DataProvider
    public Object[][] checkDifferentSizeValue() {
        return new Object[][]{
                {100, 200.0, "Hello", "Write method should return empty string because sizeLetter is more than ink"},
                {100, 0, "Hello", "Write method should return empty string because size letter is null"},
                {100, -5, "Hello", "Write method should return empty string because size letter is negative"}
        };
    }
    @DataProvider
    public Object[][] checkPartOfWord() {
        return new Object[][]{
                {3, 1.0, "Daddy", "Write method should return empty string because sizeLetter is more than ink"}
        };
    }
    private Field getPrivateField(String privateFieldName) {
        Field privateField = null;
        try {
            privateField = Pen.class.getDeclaredField(privateFieldName);
        } catch (NoSuchFieldException e) {
            e.printStackTrace();
        }
        privateField.setAccessible(true);
        return privateField;
    }

    @Test(dataProvider = "inkContainerValueData")
    public void PenWithInkConstructorTest(int inkExpected) throws IllegalAccessException {
        Pen pen = new Pen(inkExpected);
        Field ink = getPrivateField("inkContainerValue");
        int inkActual = (int) ink.get(pen);
        ink.setAccessible(false);
        Assert.assertEquals(inkActual, inkExpected, "Constructor Pen with ink returns pen with incorrect ink: " + inkActual + ", but expected ink: " + inkExpected );
    }

    @Test (dataProvider = "inkAndSizeLetterData")
    public void penWithInkAndSizeConstructorTest(int inkExpected, double sizeExpected) throws IllegalAccessException {
        Pen pen = new Pen(inkExpected, sizeExpected);
        Field sizeLetter = getPrivateField("sizeLetter");
        double sizeActual = (double) sizeLetter.get(pen);
        sizeLetter.setAccessible(false);
        Assert.assertEquals(sizeActual, sizeExpected, "Constructor Pen with ink and size returns pen with incorrect size: " + sizeActual + ", but expected size: " + sizeExpected);
    }

    @Test (dataProvider = "inkSizeColorPenData")
    public void penWithInkSizeColorConstructorTest(int inkExpected, double sizeExpected, String colorExpected) throws IllegalAccessException {
        Pen pen = new Pen(inkExpected, sizeExpected, colorExpected);
        Field color = getPrivateField("color");
        String colorActual = (String) color.get(pen);
        color.setAccessible(false);
        Assert.assertEquals(colorActual, colorExpected, "Constructor Pen with ink, size, color returns pen with incorrect color: " + colorActual + ", but expected color: " + colorExpected);
    }

    @Test(dataProvider = "inkSizeColorPenData")
    public void getCurrentPenColor(int inkExpected, double sizeExpected, String colorExpected) {
        Pen pen = new Pen(inkExpected, sizeExpected, colorExpected);
        String colorActual = pen.getColor();
        Assert.assertEquals(colorActual, colorExpected, "getColor method returns incorrect color: " + colorActual + ", but should return current color: " + colorExpected);
    }

    @Test(dataProvider = "inkContainerValueData")
    public void isWorkTestInk(int inkExpected) {
        Pen pen = new Pen(inkExpected);
        Boolean isPenWork = pen.isWork();
        Assert.assertTrue(isPenWork, "isWork method returns " + isPenWork + ", but should return true");
    }

    @Test(dataProvider = "negativeInkDataAndWord")
    public void writeTestWithNegativeInk(int inkExpected, String word) {
        Pen pen = new Pen(inkExpected);
        String actualResult = pen.write(word);
        Assert.assertEquals(actualResult, "", "Write method should return empty string, but actual result: " + actualResult);
    }

    @Test(dataProvider = "positiveInkSizeAndWord")
    public void writeTestIfInkMoreThanWordLength(int inkExpected, double sizeExpected, String word) {
        Pen pen = new Pen(inkExpected, sizeExpected);
        String actualResult = pen.write(word);
        Assert.assertEquals(actualResult, word, "Write method should return: " + word + ", but actual result: " + actualResult);
    }

    @Parameters("spaces")
    @Test
    public void isWorkTestAfterInputSpaces(@Optional("  ") String spaces) {
        int ink = spaces.length();
        Pen pen = new Pen(ink);
        pen.write(spaces);
        Assert.assertTrue(pen.isWork(), "Pen should still be able to work after writing spaces, isWork method should return true, but actual result: " + pen.isWork());
    }

    @Parameters("word")
    @Test
    public void writeTestIfInkEqualsWordLengthAndWriteSpace(@Optional("Hello") String word) {
        Pen pen = new Pen(word.length(), 1.0);
        String characterBeforeWord = " ";
        pen.write(characterBeforeWord);
        String actualResult = pen.write(word);
        Assert.assertEquals(actualResult, word, "Write method should return word: " + word + ", but pen use ink to write: " + "'" + characterBeforeWord + "'");
    }

    @Test(dataProvider = "checkSymbols")
    public void writeTestForSymbolGroups(int ink, double size, String word, String message) {
        Pen pen = new Pen(ink, size);
        String actualResult = pen.write(word);
        Assert.assertEquals(actualResult, word, message);
    }

    @Test(dataProvider = "checkDifferentInkAndSizeValue")
    public void writeTestWithDifferentInkAndSizeValue(int ink, double size, String word, String message) {
        Pen pen = new Pen(ink, size);
        String actualResult = pen.write(word);
        Assert.assertEquals(actualResult, word, message);
    }

    @Test(dataProvider = "checkDifferentSizeValue")
    public void writeTestWithDifferentSize(int ink, double size, String word, String message) {
        Pen pen = new Pen(ink, size);
        String actualResult = pen.write(word);
        Assert.assertTrue(actualResult.isEmpty(), message);
        }

    @Test(dataProvider = "checkPartOfWord")
    public void writeTestIfInkLessThanWordLength(int ink, double size, String word, String message) {
        Pen pen = new Pen (ink, size);
        String expectedResult = word.substring(0, ink);
        String actualResult = pen.write(word);
        Assert.assertEquals(actualResult, expectedResult, message);
    }

    @Test(dataProvider = "inkSizeColorPenData")
    public void doSomethingElseTest(int ink, double size, String color) {
        Pen pen = new Pen(ink, size, color);
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        System.setOut(new PrintStream(byteArrayOutputStream));
        pen.doSomethingElse();
        Assert.assertEquals(byteArrayOutputStream.toString().trim(), color);
        System.setOut(null);
    }
}